name: Build Docker Images

on:
  push:
    branches:
      - main
      - develop
      - stage
  workflow_dispatch:
    inputs:
      build-api:
        description: 'Build API image'
        required: true
        type: boolean
        default: true
      build-web:
        description: 'Build web image'
        required: true
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io

jobs:
  # Detect which projects are affected using Turbo or manual inputs
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      api: ${{ steps.affected.outputs.api }}
      web: ${{ steps.affected.outputs.web }}
    steps:
      - name: Check manual trigger
        id: manual
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected"
            echo "api=${{ inputs.build-api }}" >> $GITHUB_OUTPUT
            echo "web=${{ inputs.build-web }}" >> $GITHUB_OUTPUT
            echo "is_manual=true" >> $GITHUB_OUTPUT
          else
            echo "is_manual=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.manual.outputs.is_manual != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        if: steps.manual.outputs.is_manual != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.manual.outputs.is_manual != 'true'
        run: npm ci

      - name: Check affected projects
        id: affected
        run: |
          if [ "${{ steps.manual.outputs.is_manual }}" = "true" ]; then
            echo "Using manual inputs"
            echo "api=${{ steps.manual.outputs.api }}" >> $GITHUB_OUTPUT
            echo "web=${{ steps.manual.outputs.web }}" >> $GITHUB_OUTPUT
          else
            # Get the list of affected projects
            AFFECTED=$(npx turbo ls --affected --output=json 2>/dev/null || echo '[]')
            echo "Affected projects: $AFFECTED"

            # Check if api is affected
            if echo "$AFFECTED" | grep -q '"api"'; then
              echo "api=true" >> $GITHUB_OUTPUT
            else
              echo "api=false" >> $GITHUB_OUTPUT
            fi

            # Check if web is affected
            if echo "$AFFECTED" | grep -q '"web"'; then
              echo "web=true" >> $GITHUB_OUTPUT
            else
              echo "web=false" >> $GITHUB_OUTPUT
            fi
          fi

  # Build Docker images for affected projects
  build:
    needs: changes
    if: needs.changes.outputs.api == 'true' || needs.changes.outputs.web == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        app:
          - name: api
            dockerfile: ./apps/api/Dockerfile
          - name: web
            dockerfile: ./apps/web/Dockerfile

    steps:
    - name: Check if app is affected
      id: should-build
      run: |
        if [ "${{ matrix.app.name }}" = "api" ] && [ "${{ needs.changes.outputs.api }}" = "true" ]; then
          echo "build=true" >> $GITHUB_OUTPUT
        elif [ "${{ matrix.app.name }}" = "web" ] && [ "${{ needs.changes.outputs.web }}" = "true" ]; then
          echo "build=true" >> $GITHUB_OUTPUT
        else
          echo "build=false" >> $GITHUB_OUTPUT
        fi

    - name: Checkout repository
      if: steps.should-build.outputs.build == 'true'
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      if: steps.should-build.outputs.build == 'true'
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      if: steps.should-build.outputs.build == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      if: steps.should-build.outputs.build == 'true'
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.app.name }}
        tags: |
          type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
          type=raw,value=develop,enable=${{ github.ref == 'refs/heads/develop' }}
          type=raw,value=stage,enable=${{ github.ref == 'refs/heads/stage' }}
          type=sha,prefix={{branch}}-,format=short
        flavor: |
          latest=false

    - name: Build and push ${{ matrix.app.name }} Docker image
      if: steps.should-build.outputs.build == 'true'
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ matrix.app.dockerfile }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=${{ matrix.app.name }}
        cache-to: type=gha,mode=max,scope=${{ matrix.app.name }}
        build-args: |
          NODE_ENV=production

    - name: Image digest
      if: steps.should-build.outputs.build == 'true'
      run: echo "Built ${{ matrix.app.name }} image with tags ${{ steps.meta.outputs.tags }}"
